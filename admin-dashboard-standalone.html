<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Time Clock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="logo.svg" alt="DMH Logo" style="width: 50px; height: 50px; object-fit: contain;" onerror="this.style.display='none'">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Admin Dashboard</h1>
                    <p class="text-sm text-gray-600" id="userName">Loading...</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <a href="dashboard-standalone.html" class="text-blue-600 hover:text-blue-700">
                    <i class="fas fa-clock mr-2"></i>Employee View
                </a>
                <button onclick="handleLogout()" class="text-red-600 hover:text-red-700 font-semibold">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4">
            <nav class="flex space-x-8">
                <button onclick="showTab('overview')" id="tab-overview" class="tab-btn py-4 px-2 border-b-2 border-blue-600 text-blue-600 font-semibold">
                    <i class="fas fa-home mr-2"></i>Overview
                </button>
                <button onclick="showTab('users')" id="tab-users" class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    <i class="fas fa-users mr-2"></i>Users
                </button>
                <button onclick="showTab('locations')" id="tab-locations" class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    <i class="fas fa-map-marker-alt mr-2"></i>Locations
                </button>
                <button onclick="showTab('timesheets')" id="tab-timesheets" class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">
                    <i class="fas fa-clock mr-2"></i>All Timesheets
                </button>
            </nav>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 mt-4">
        
        <!-- Overview Tab -->
        <div id="content-overview" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Total Users -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-blue-100 rounded-full p-3 mr-4">
                            <i class="fas fa-users text-2xl text-blue-600"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Total Users</p>
                            <p class="text-2xl font-bold text-gray-800" id="stat-users">0</p>
                        </div>
                    </div>
                </div>

                <!-- Active Locations -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-green-100 rounded-full p-3 mr-4">
                            <i class="fas fa-map-marker-alt text-2xl text-green-600"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Active Locations</p>
                            <p class="text-2xl font-bold text-gray-800" id="stat-locations">0</p>
                        </div>
                    </div>
                </div>

                <!-- Today's Clock-ins -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-purple-100 rounded-full p-3 mr-4">
                            <i class="fas fa-clock text-2xl text-purple-600"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Today's Clock-ins</p>
                            <p class="text-2xl font-bold text-gray-800" id="stat-clockins">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-history mr-2"></i>Recent Activity
                </h3>
                <div id="recent-activity" class="space-y-3">
                    <p class="text-gray-600">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="content-users" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-users mr-2"></i>Manage Users
                    </h3>
                    <button onclick="showAddUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Add User
                    </button>
                </div>
                <div class="p-6">
                    <div id="users-list">
                        <p class="text-gray-600">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Locations Tab -->
        <div id="content-locations" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-map-marker-alt mr-2"></i>Work Locations
                    </h3>
                    <button onclick="showAddLocationModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Add Location
                    </button>
                </div>
                <div class="p-6">
                    <div id="locations-list">
                        <p class="text-gray-600">Loading locations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timesheets Tab -->
        <div id="content-timesheets" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-clock mr-2"></i>All Timesheets
                    </h3>
                    <div class="flex space-x-4">
                        <input type="date" id="filter-date-start" class="border rounded px-3 py-2">
                        <input type="date" id="filter-date-end" class="border rounded px-3 py-2">
                        <button onclick="loadTimesheets()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-search mr-2"></i>Filter
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="timesheets-list">
                        <p class="text-gray-600">Loading timesheets...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://dgfzrkbgrzenukjelnjl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnZnpya2JncnplbnVramVsbmpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NjgwNjcsImV4cCI6MjA4NTA0NDA2N30.09RieWZ-iB23e94iA5BWaYR4KHFFC9FOSV1O8ZeUIz4';
        
        const adminClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await requireAdmin();
            if (!currentUser) return;

            document.getElementById('userName').textContent = currentUser.full_name + ' (Admin)';
            
            await loadDashboardData();
        });

        async function requireAdmin() {
            try {
                const { data: { user } } = await adminClient.auth.getUser();
                
                if (!user) {
                    window.location.href = 'login-standalone.html';
                    return;
                }

                const { data: userProfile } = await adminClient
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (!userProfile || userProfile.role !== 'admin') {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = 'dashboard-standalone.html';
                    return;
                }

                currentUser = userProfile;
                console.log('Admin logged in:', currentUser.full_name);
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = 'login-standalone.html';
            }
        }

        async function handleLogout() {
            await adminClient.auth.signOut();
            window.location.href = 'login-standalone.html';
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('border-blue-600', 'text-blue-600');
                el.classList.add('border-transparent', 'text-gray-600');
            });

            // Show selected tab
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.remove('border-transparent', 'text-gray-600');
            document.getElementById('tab-' + tabName).classList.add('border-blue-600', 'text-blue-600');

            // Load data for tab
            if (tabName === 'users') loadUsers();
            if (tabName === 'locations') loadLocations();
            if (tabName === 'timesheets') loadTimesheets();
        }

        async function loadDashboardData() {
            try {
                // Load stats
                const { data: users } = await adminClient.from('users').select('id', { count: 'exact' });
                const { data: locations } = await adminClient.from('work_locations').select('id', { count: 'exact' }).eq('is_active', true);
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const { data: clockins } = await adminClient
                    .from('time_entries')
                    .select('id', { count: 'exact' })
                    .gte('clock_in_time', today.toISOString());

                document.getElementById('stat-users').textContent = users?.length || 0;
                document.getElementById('stat-locations').textContent = locations?.length || 0;
                document.getElementById('stat-clockins').textContent = clockins?.length || 0;

                // Load recent activity
                const { data: recentEntries } = await adminClient
                    .from('time_entries')
                    .select('*, users(full_name, email)')
                    .order('created_at', { ascending: false })
                    .limit(5);

                let activityHTML = '';
                if (recentEntries && recentEntries.length > 0) {
                    recentEntries.forEach(entry => {
                        const time = new Date(entry.clock_in_time).toLocaleString();
                        const status = entry.status === 'clocked_in' ? 'Clocked In' : 'Clocked Out';
                        activityHTML += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                                <div>
                                    <p class="font-semibold">${entry.users?.full_name || 'Unknown'}</p>
                                    <p class="text-sm text-gray-600">${status} at ${time}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded ${entry.status === 'clocked_in' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${entry.status}</span>
                            </div>
                        `;
                    });
                } else {
                    activityHTML = '<p class="text-gray-600">No recent activity</p>';
                }
                document.getElementById('recent-activity').innerHTML = activityHTML;

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadUsers() {
            try {
                const { data: users, error } = await adminClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
                html += `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                `;

                users.forEach(user => {
                    const statusBadge = user.is_active 
                        ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Active</span>'
                        : '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Inactive</span>';
                    
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${user.full_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${user.role}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button onclick="editUser('${user.id}')" class="text-blue-600 hover:text-blue-800 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleUserStatus('${user.id}', ${user.is_active})" class="text-gray-600 hover:text-gray-800">
                                    <i class="fas fa-${user.is_active ? 'ban' : 'check'}"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                document.getElementById('users-list').innerHTML = html;

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-list').innerHTML = '<p class="text-red-600">Error loading users</p>';
            }
        }

        async function loadLocations() {
            try {
                const { data: locations, error } = await adminClient
                    .from('work_locations')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

                locations.forEach(location => {
                    const statusBadge = location.is_active 
                        ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Active</span>'
                        : '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Inactive</span>';
                    
                    html += `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-gray-800">${location.name}</h4>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${location.address || 'No address'}</p>
                            <p class="text-xs text-gray-500 mb-2">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                ${location.latitude}, ${location.longitude}
                            </p>
                            <p class="text-xs text-gray-500 mb-3">
                                <i class="fas fa-circle-notch mr-1"></i>
                                Radius: ${location.radius_meters}m
                            </p>
                            <div class="flex space-x-2">
                                <button onclick="editLocation('${location.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                <button onclick="toggleLocationStatus('${location.id}', ${location.is_active})" class="text-gray-600 hover:text-gray-800 text-sm">
                                    <i class="fas fa-${location.is_active ? 'ban' : 'check'} mr-1"></i>
                                    ${location.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                document.getElementById('locations-list').innerHTML = html;

            } catch (error) {
                console.error('Error loading locations:', error);
                document.getElementById('locations-list').innerHTML = '<p class="text-red-600">Error loading locations</p>';
            }
        }

        async function loadTimesheets() {
            try {
                const { data: entries, error } = await adminClient
                    .from('time_entries')
                    .select('*, users(full_name, email), work_locations!clock_in_location_id(name)')
                    .order('clock_in_time', { ascending: false })
                    .limit(50);

                if (error) throw error;

                let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
                html += `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clock In</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clock Out</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hours</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                `;

                entries.forEach(entry => {
                    const clockIn = new Date(entry.clock_in_time).toLocaleString();
                    const clockOut = entry.clock_out_time ? new Date(entry.clock_out_time).toLocaleString() : 'Active';
                    const hours = entry.total_hours || '0.00';
                    const location = entry.work_locations?.name || 'Unknown';
                    
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">${entry.users?.full_name || 'Unknown'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${clockIn}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${clockOut}</td>
                            <td class="px-6 py-4 whitespace-nowrap font-semibold">${hours}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${location}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full bg-${entry.status === 'clocked_in' ? 'green' : 'gray'}-100 text-${entry.status === 'clocked_in' ? 'green' : 'gray'}-800">
                                    ${entry.status}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                document.getElementById('timesheets-list').innerHTML = html;

            } catch (error) {
                console.error('Error loading timesheets:', error);
                document.getElementById('timesheets-list').innerHTML = '<p class="text-red-600">Error loading timesheets</p>';
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            if (!confirm(`Are you sure you want to ${currentStatus ? 'deactivate' : 'activate'} this user?`)) return;

            try {
                const { error } = await adminClient
                    .from('users')
                    .update({ is_active: !currentStatus })
                    .eq('id', userId);

                if (error) throw error;

                alert('User status updated successfully');
                loadUsers();
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error updating user status');
            }
        }

        async function toggleLocationStatus(locationId, currentStatus) {
            if (!confirm(`Are you sure you want to ${currentStatus ? 'deactivate' : 'activate'} this location?`)) return;

            try {
                const { error } = await adminClient
                    .from('work_locations')
                    .update({ is_active: !currentStatus })
                    .eq('id', locationId);

                if (error) throw error;

                alert('Location status updated successfully');
                loadLocations();
            } catch (error) {
                console.error('Error updating location:', error);
                alert('Error updating location status');
            }
        }

        function showAddUserModal() {
            alert('Add User functionality coming soon! For now, users can sign up via the signup page.');
        }

        function showAddLocationModal() {
            alert('Add Location functionality coming soon! For now, add locations via SQL in Supabase.');
        }

        function editUser(userId) {
            alert('Edit User functionality coming soon!');
        }

        function editLocation(locationId) {
            alert('Edit Location functionality coming soon!');
        }
    </script>
</body>
</html>
