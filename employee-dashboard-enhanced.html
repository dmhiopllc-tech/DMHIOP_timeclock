<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard - Enhanced with PTO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        .clock-btn { transition: all 0.3s ease; }
        .clock-btn:active { transform: scale(0.95); }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes bounce-in {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-bounce-in { animation: bounce-in 0.5s ease-out; }
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="logo.svg" alt="DMH Logo" style="width: 50px; height: 50px; object-fit: contain;" onerror="this.style.display='none'">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Time Clock</h1>
                    <p class="text-sm text-gray-600" id="userName">Loading...</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div id="monitoringStatus" class="text-xs text-gray-500">
                    <i class="fas fa-satellite-dish mr-1"></i>Monitoring...
                </div>
                <button onclick="handleLogout()" class="text-red-600 hover:text-red-700 font-semibold">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Today's Summary -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Today's Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Status</p>
                            <p class="text-xl font-bold text-blue-600" id="clockStatus">Clocked Out</p>
                        </div>
                        <i class="fas fa-clock text-3xl text-blue-600"></i>
                    </div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Hours Today</p>
                            <p class="text-xl font-bold text-green-600" id="hoursToday">0.0</p>
                        </div>
                        <i class="fas fa-business-time text-3xl text-green-600"></i>
                    </div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Clock In</p>
                            <p class="text-lg font-bold text-purple-600" id="clockInTime">--:--</p>
                        </div>
                        <i class="fas fa-sign-in-alt text-3xl text-purple-600"></i>
                    </div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Clock Out</p>
                            <p class="text-lg font-bold text-orange-600" id="clockOutTime">--:--</p>
                        </div>
                        <i class="fas fa-sign-out-alt text-3xl text-orange-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clock In/Out Buttons -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
            <div class="flex justify-center space-x-4">
                <button id="clockInBtn" onclick="handleClockIn()" 
                    class="clock-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-6 px-12 rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-play-circle text-3xl mb-2"></i>
                    <p class="text-xl">Clock In</p>
                </button>
                <button id="clockOutBtn" onclick="handleClockOut()" disabled
                    class="clock-btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-6 px-12 rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-stop-circle text-3xl mb-2"></i>
                    <p class="text-xl">Clock Out</p>
                </button>
            </div>
            <p class="text-center text-sm text-gray-500 mt-4">
                <i class="fas fa-map-marker-alt mr-1"></i>
                Location verification enabled
            </p>
        </div>

        <!-- PTO & Sick Time Balances -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- PTO Balance -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">PTO Balance</h3>
                    <i class="fas fa-umbrella-beach text-2xl text-blue-600"></i>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Available</span>
                        <span id="ptoBalance">0 / 40 hours</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="ptoProgress" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <button onclick="showRequestTimeOffModal('PTO')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
                    <i class="fas fa-calendar-plus mr-2"></i>Request PTO
                </button>
            </div>

            <!-- Sick Time Balance -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Sick Time Balance</h3>
                    <i class="fas fa-user-md text-2xl text-green-600"></i>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Available</span>
                        <span id="sickBalance">0 / 16 hours</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="sickProgress" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                <button onclick="showRequestTimeOffModal('Sick')" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">
                    <i class="fas fa-calendar-plus mr-2"></i>Request Sick Time
                </button>
            </div>
        </div>

        <!-- Pay Period Hours -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Current Pay Period</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="border-l-4 border-blue-600 pl-4">
                    <p class="text-sm text-gray-600">Regular Hours</p>
                    <p class="text-2xl font-bold text-gray-800" id="regularHours">0.0</p>
                </div>
                <div class="border-l-4 border-yellow-600 pl-4">
                    <p class="text-sm text-gray-600">Overtime Hours</p>
                    <p class="text-2xl font-bold text-gray-800" id="overtimeHours">0.0</p>
                </div>
                <div class="border-l-4 border-purple-600 pl-4">
                    <p class="text-sm text-gray-600">Total Hours</p>
                    <p class="text-2xl font-bold text-gray-800" id="totalHours">0.0</p>
                </div>
            </div>
        </div>

        <!-- Time Off Requests -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">My Time-Off Requests</h3>
            <div id="timeOffRequests">
                <p class="text-gray-500 text-center py-8">No pending requests</p>
            </div>
        </div>

    </main>

    <!-- Request Time Off Modal -->
    <div id="timeOffModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Request Time Off</h3>
            <form id="timeOffForm" onsubmit="submitTimeOffRequest(event)">
                <input type="hidden" id="requestType" name="requestType">
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Type</label>
                    <input type="text" id="requestTypeDisplay" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                    <input type="date" id="startDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                    <input type="date" id="endDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Hours Requested</label>
                    <input type="number" id="hoursRequested" step="0.5" min="0.5" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Notes (Optional)</label>
                    <textarea id="requestNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
                        Submit Request
                    </button>
                    <button type="button" onclick="closeTimeOffModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="timeclock-config.js"></script>
    <script src="timeclock-auth-v2.js"></script>
    <script>
        let currentUser = null;
        let currentTimeEntry = null;
        let employeeClient = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await requireAuth();
            await loadCurrentStatus();
            await loadTodaySummary();
            await loadPTOBalances();
            await loadPayPeriodHours();
            await loadTimeOffRequests();
            initializeGeofenceMonitor();
            registerServiceWorker();
        });

        async function requireAuth() {
            try {
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                
                if (authError || !user) {
                    window.location.href = 'login-v3.html';
                    return;
                }

                employeeClient = supabaseClient;

                const { data: userProfile, error: profileError } = await employeeClient
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profileError || !userProfile) {
                    alert('Error loading user profile');
                    window.location.href = 'login-v3.html';
                    return;
                }

                currentUser = userProfile;
                document.getElementById('userName').textContent = currentUser.full_name;

            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = 'login-v3.html';
            }
        }

        async function handleLogout() {
            // Stop geofence monitoring
            if (geofenceCheckInterval) {
                clearInterval(geofenceCheckInterval);
            }
            
            await supabaseClient.auth.signOut();
            window.location.href = 'login-v3.html';
        }

        async function loadCurrentStatus() {
            try {
                const { data, error } = await employeeClient
                    .from('time_entries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('status', 'clocked_in')
                    .order('clock_in_time', { ascending: false })
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data) {
                    currentTimeEntry = data;
                    updateUIForClockedIn(data);
                } else {
                    currentTimeEntry = null;
                    updateUIForClockedOut();
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        function updateUIForClockedIn(entry) {
            document.getElementById('clockStatus').textContent = 'Clocked In';
            document.getElementById('clockStatus').classList.remove('text-blue-600');
            document.getElementById('clockStatus').classList.add('text-green-600');
            
            const clockInTime = new Date(entry.clock_in_time);
            document.getElementById('clockInTime').textContent = clockInTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            document.getElementById('clockInBtn').disabled = true;
            document.getElementById('clockOutBtn').disabled = false;

            startElapsedTimer(clockInTime);

            if (geofenceMonitor) {
                geofenceMonitor.updateClockStatus(true, entry.location_id);
            }
        }

        function updateUIForClockedOut() {
            document.getElementById('clockStatus').textContent = 'Clocked Out';
            document.getElementById('clockStatus').classList.remove('text-green-600');
            document.getElementById('clockStatus').classList.add('text-blue-600');
            
            document.getElementById('clockInTime').textContent = '--:--';
            document.getElementById('clockOutTime').textContent = '--:--';
            document.getElementById('hoursToday').textContent = '0.0';

            document.getElementById('clockInBtn').disabled = false;
            document.getElementById('clockOutBtn').disabled = true;

            if (window.elapsedTimerInterval) {
                clearInterval(window.elapsedTimerInterval);
            }

            if (geofenceMonitor) {
                geofenceMonitor.updateClockStatus(false, null);
            }
        }

        function startElapsedTimer(clockInTime) {
            if (window.elapsedTimerInterval) {
                clearInterval(window.elapsedTimerInterval);
            }

            const updateElapsed = () => {
                const now = new Date();
                const elapsed = (now - clockInTime) / 1000 / 60 / 60;
                document.getElementById('hoursToday').textContent = elapsed.toFixed(2);
            };

            updateElapsed();
            window.elapsedTimerInterval = setInterval(updateElapsed, 30000);
        }

        async function handleClockIn() {
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });

                const validation = await validateGeofence(position.coords.latitude, position.coords.longitude);
                
                if (!validation.valid) {
                    alert(validation.message || 'You must be at a work location to clock in.');
                    return;
                }

                const { data, error } = await employeeClient
                    .from('time_entries')
                    .insert({
                        user_id: currentUser.id,
                        clock_in_time: new Date().toISOString(),
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        location_id: validation.location.id,
                        status: 'clocked_in'
                    })
                    .select()
                    .single();

                if (error) throw error;

                currentTimeEntry = data;
                updateUIForClockedIn(data);
                
                // Log geofence entry event
                await logGeofenceEvent('entry', validation.location);

                alert('‚úÖ Clocked in successfully!');
                await loadTodaySummary();
            } catch (error) {
                console.error('Clock in error:', error);
                alert('Error clocking in: ' + error.message);
            }
        }

        async function handleClockOut() {
            if (!currentTimeEntry) {
                alert('No active clock-in found.');
                return;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });

                const clockOutTime = new Date();
                const clockInTime = new Date(currentTimeEntry.clock_in_time);
                const hoursWorked = (clockOutTime - clockInTime) / 1000 / 60 / 60;

                const { error } = await employeeClient
                    .from('time_entries')
                    .update({
                        clock_out_time: clockOutTime.toISOString(),
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        total_hours: hoursWorked.toFixed(2),
                        status: 'completed'
                    })
                    .eq('id', currentTimeEntry.id);

                if (error) throw error;

                document.getElementById('clockOutTime').textContent = clockOutTime.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                // Log geofence exit event
                const validation = await validateGeofence(position.coords.latitude, position.coords.longitude);
                if (validation.valid) {
                    await logGeofenceEvent('exit', validation.location);
                }

                currentTimeEntry = null;
                updateUIForClockedOut();

                alert('‚úÖ Clocked out successfully!\nHours worked: ' + hoursWorked.toFixed(2));
                await loadTodaySummary();
                await loadPayPeriodHours();
            } catch (error) {
                console.error('Clock out error:', error);
                alert('Error clocking out: ' + error.message);
            }
        }

        async function loadTodaySummary() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await employeeClient
                    .from('time_entries')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('clock_in_time', today + 'T00:00:00')
                    .lte('clock_in_time', today + 'T23:59:59');

                if (error) throw error;

                let totalHours = 0;
                if (data && data.length > 0) {
                    data.forEach(entry => {
                        if (entry.total_hours) {
                            totalHours += parseFloat(entry.total_hours);
                        }
                    });
                }

                if (!currentTimeEntry) {
                    document.getElementById('hoursToday').textContent = totalHours.toFixed(2);
                }
            } catch (error) {
                console.error('Error loading today summary:', error);
            }
        }

        async function loadPTOBalances() {
            try {
                const { data, error } = await employeeClient
                    .from('pto_balances')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data) {
                    const ptoAvailable = data.pto_available || 0;
                    const ptoTotal = data.pto_total || 40;
                    const sickAvailable = data.sick_available || 0;
                    const sickTotal = data.sick_total || 16;

                    document.getElementById('ptoBalance').textContent = `${ptoAvailable} / ${ptoTotal} hours`;
                    document.getElementById('ptoProgress').style.width = `${(ptoAvailable / ptoTotal) * 100}%`;

                    document.getElementById('sickBalance').textContent = `${sickAvailable} / ${sickTotal} hours`;
                    document.getElementById('sickProgress').style.width = `${(sickAvailable / sickTotal) * 100}%`;
                }
            } catch (error) {
                console.error('Error loading PTO balances:', error);
            }
        }

        async function loadPayPeriodHours() {
            try {
                const { data, error } = await employeeClient
                    .from('current_pay_period_hours')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data) {
                    const regular = data.regular_hours || 0;
                    const overtime = data.overtime_hours || 0;
                    const total = regular + overtime;

                    document.getElementById('regularHours').textContent = regular.toFixed(1);
                    document.getElementById('overtimeHours').textContent = overtime.toFixed(1);
                    document.getElementById('totalHours').textContent = total.toFixed(1);
                }
            } catch (error) {
                console.error('Error loading pay period hours:', error);
            }
        }

        async function loadTimeOffRequests() {
            try {
                const { data, error } = await employeeClient
                    .from('time_off_requests')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('timeOffRequests');
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No time-off requests</p>';
                    return;
                }

                let html = '<div class="space-y-3">';
                data.forEach(request => {
                    const statusColor = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'approved': 'bg-green-100 text-green-800',
                        'rejected': 'bg-red-100 text-red-800'
                    }[request.status] || 'bg-gray-100 text-gray-800';

                    const startDate = new Date(request.start_date).toLocaleDateString();
                    const endDate = new Date(request.end_date).toLocaleDateString();

                    html += `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="font-semibold text-gray-800">${request.request_type}</span>
                                    <span class="ml-2 text-sm text-gray-600">${request.hours_requested} hours</span>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">
                                    ${request.status.toUpperCase()}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600">
                                <i class="far fa-calendar mr-1"></i>
                                ${startDate} - ${endDate}
                            </p>
                            ${request.employee_note ? `<p class="text-sm text-gray-500 mt-2 italic">"${request.employee_note}"</p>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading time-off requests:', error);
            }
        }

        function showRequestTimeOffModal(type) {
            document.getElementById('requestType').value = type;
            document.getElementById('requestTypeDisplay').value = type;
            document.getElementById('timeOffModal').classList.remove('hidden');
            document.getElementById('timeOffModal').classList.add('flex');
        }

        function closeTimeOffModal() {
            document.getElementById('timeOffModal').classList.add('hidden');
            document.getElementById('timeOffModal').classList.remove('flex');
            document.getElementById('timeOffForm').reset();
        }

        async function submitTimeOffRequest(event) {
            event.preventDefault();

            const requestType = document.getElementById('requestType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const hoursRequested = parseFloat(document.getElementById('hoursRequested').value);
            const notes = document.getElementById('requestNotes').value;

            try {
                const { error } = await employeeClient
                    .from('time_off_requests')
                    .insert({
                        user_id: currentUser.id,
                        request_type: requestType,
                        start_date: startDate,
                        end_date: endDate,
                        hours_requested: hoursRequested,
                        employee_note: notes,
                        status: 'pending'
                    });

                if (error) throw error;

                alert('‚úÖ Time-off request submitted successfully!');
                closeTimeOffModal();
                await loadTimeOffRequests();
            } catch (error) {
                console.error('Error submitting request:', error);
                alert('Error submitting request: ' + error.message);
            }
        }

        async function validateGeofence(userLat, userLon) {
            try {
                const { data: locations, error } = await employeeClient
                    .from('work_locations')
                    .select('*')
                    .eq('is_active', true);

                if (error) throw error;

                if (!locations || locations.length === 0) {
                    return {
                        valid: false,
                        message: 'No active work locations found.'
                    };
                }

                let nearestLocation = null;
                let minDistance = Infinity;

                for (const location of locations) {
                    const distance = calculateDistance(userLat, userLon, location.latitude, location.longitude);

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestLocation = location;
                    }

                    if (distance <= location.radius_meters) {
                        return {
                            valid: true,
                            location: location,
                            distance: distance
                        };
                    }
                }

                return {
                    valid: false,
                    message: `You are ${Math.round(minDistance)} meters from ${nearestLocation.name}. You must be within ${nearestLocation.radius_meters} meters.`,
                    nearestLocation: nearestLocation,
                    distance: minDistance
                };
            } catch (error) {
                return {
                    valid: false,
                    message: 'Error validating location: ' + error.message
                };
            }
        }

        // Geofence Monitor (simplified inline version)
        let lastKnownPosition = null;
        let lastKnownLocationId = null;
        let geofenceCheckInterval = null;

        function initializeGeofenceMonitor() {
            console.log('üéØ Geofence monitoring ready');
            document.getElementById('monitoringStatus').innerHTML = '<i class="fas fa-satellite-dish mr-1 text-green-500"></i>Active';
            
            // Start checking geofence every 30 seconds
            geofenceCheckInterval = setInterval(checkGeofenceStatus, 30000);
        }

        async function checkGeofenceStatus() {
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });

                const validation = await validateGeofence(position.coords.latitude, position.coords.longitude);
                
                // If inside geofence
                if (validation.valid) {
                    // Check if this is a new entry
                    if (!lastKnownLocationId || lastKnownLocationId !== validation.location.id) {
                        console.log('üìç Entered geofence:', validation.location.name);
                        await logGeofenceEvent('entry', validation.location);
                        
                        // Warn if not clocked in
                        if (!currentTimeEntry) {
                            console.warn('‚ö†Ô∏è At work location but not clocked in');
                            // You could show a notification here
                        }
                    }
                    lastKnownLocationId = validation.location.id;
                } else {
                    // If was inside but now outside
                    if (lastKnownLocationId) {
                        console.log('üìç Exited geofence');
                        // Log exit event
                        const { data: location } = await employeeClient
                            .from('work_locations')
                            .select('*')
                            .eq('id', lastKnownLocationId)
                            .single();
                        
                        if (location) {
                            await logGeofenceEvent('exit', location);
                        }
                        
                        lastKnownLocationId = null;
                    }
                }

                lastKnownPosition = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };

            } catch (error) {
                console.error('Geofence check error:', error);
            }
        }

        async function logGeofenceEvent(eventType, location) {
            try {
                const eventData = {
                    user_id: currentUser.id,
                    location_id: location.id,
                    event_type: eventType,
                    event_time: new Date().toISOString(),
                    latitude: lastKnownPosition?.latitude,
                    longitude: lastKnownPosition?.longitude,
                    has_clock_entry: currentTimeEntry ? true : false
                };

                // Link to time entry if clocked in
                if (currentTimeEntry && eventType === 'entry') {
                    eventData.related_time_entry_id = currentTimeEntry.id;
                }

                const { error } = await employeeClient
                    .from('geofence_events')
                    .insert(eventData);

                if (error) throw error;

                console.log(`‚úÖ Logged ${eventType} event for ${location.name}`);

                // If entry but no clock-in, create admin alert after 5 minutes
                if (eventType === 'entry' && !currentTimeEntry) {
                    setTimeout(async () => {
                        // Check if still not clocked in after 5 minutes
                        if (!currentTimeEntry) {
                            await createAdminAlert(location);
                        }
                    }, 5 * 60 * 1000); // 5 minutes
                }

            } catch (error) {
                console.error('Error logging geofence event:', error);
            }
        }

        async function createAdminAlert(location) {
            try {
                const { error } = await employeeClient
                    .from('admin_alerts')
                    .insert({
                        user_id: currentUser.id,
                        location_id: location.id,
                        alert_type: 'missing_clock_in',
                        severity: 'medium',
                        alert_time: new Date().toISOString(),
                        message: `${currentUser.full_name} arrived at ${location.name} but has not clocked in`,
                        is_resolved: false
                    });

                if (error) throw error;
                console.log('‚ö†Ô∏è Admin alert created for missing clock-in');
            } catch (error) {
                console.error('Error creating admin alert:', error);
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/pwa-service-worker.js');
                    console.log('‚úÖ PWA Service Worker registered');
                } catch (error) {
                    console.error('PWA Service Worker registration failed:', error);
                }
            }
        }
    </script>
</body>
</html>
